name: Component Model P2 Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-components:
    name: Build all P2 components with cargo-component
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1, wasm32-wasip2

      - name: Enable cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-component
        run: cargo install cargo-component --locked

      - name: Build validation component
        run: cd components/validation && cargo component build --release

      - name: Build retry-logic component
        run: cd components/retry-logic && cargo component build --release

      - name: Build business-logic component
        run: cd components/business-logic && cargo component build --release

      - name: Build circuit-breaker component
        run: cd components/circuit-breaker && cargo component build --release

      - name: Build data-transform component
        run: cd components/data-transform && cargo component build --release

      - name: Build toyota-api-types component
        run: cd components/toyota-api-types && cargo component build --release

      - name: Build metrics component
        run: cd components/metrics && cargo component build --release

      - name: Upload component artifacts
        uses: actions/upload-artifact@v5
        with:
          name: wasm-components-p2
          path: target/wasm32-wasip1/release/*.wasm
          retention-days: 7

  validate-components:
    name: Validate Component Model compliance
    runs-on: ubuntu-latest
    needs: build-components
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download component artifacts
        uses: actions/download-artifact@v5
        with:
          name: wasm-components-p2
          path: target/wasm32-wasip1/release/

      - name: Install wasm-tools
        run: cargo install wasm-tools --locked

      - name: Validate all components
        run: |
          echo "Validating Component Model components..."
          for component in target/wasm32-wasip1/release/*.wasm; do
            echo "=== Validating $(basename $component) ==="
            wasm-tools validate "$component"
            wasm-tools component wit "$component" || true
          done

  build-bazel:
    name: Build with Bazel (WAC composition)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Bazelisk
        run: npm install

      - name: Build all components with Bazel
        run: npx bazelisk build //components/...
        continue-on-error: true  # May fail due to network restrictions

      - name: Build composed application with Bazel
        run: npx bazelisk build //:myt2abrp_app
        continue-on-error: true  # May fail due to network restrictions

      - name: Upload Bazel build artifacts
        if: success()
        uses: actions/upload-artifact@v5
        with:
          name: bazel-wasm-composed
          path: bazel-bin/myt2abrp_app.wasm
          retention-days: 7

  wac-compose:
    name: WAC composition (manual)
    runs-on: ubuntu-latest
    needs: build-components
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download component artifacts
        uses: actions/download-artifact@v5
        with:
          name: wasm-components-p2
          path: target/wasm32-wasip1/release/

      - name: Install wac-cli
        run: cargo install wac-cli --locked

      - name: Compose with WAC
        run: wac compose compose.wac -o myt2abrp_composed.wasm
        continue-on-error: true  # May fail if gateway not built

      - name: Upload WAC composition
        if: success()
        uses: actions/upload-artifact@v5
        with:
          name: wac-composed
          path: myt2abrp_composed.wasm
          retention-days: 7

  component-test:
    name: Test individual components
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1

      - name: Enable cache
        uses: Swatinem/rust-cache@v2

      - name: Run component tests
        run: cargo test --workspace --lib --target x86_64-unknown-linux-gnu

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-components, validate-components, build-bazel, wac-compose, component-test]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Component Model P2 Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Components (cargo-component) | ${{ needs.build-components.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Components (wasm-tools) | ${{ needs.validate-components.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build with Bazel | ${{ needs.build-bazel.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WAC Composition | ${{ needs.wac-compose.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Component Tests | ${{ needs.component-test.result }} |" >> $GITHUB_STEP_SUMMARY
